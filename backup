#!/bin/bash

die(){ echo "$*" >&2; exit 1; }

command -v borg &>/dev/null \
	|| die 'Cannot find borg executable!'

BACKUP_CONF="${BACKUP_CONF:-default}"

expand_excludes(){for i in $*; do echo --exclude=$i; done;}

if [ -r "$HOME/.config/backup/${BACKUP_CONF}.env" ]; then
	. "$HOME/.config/backup/${BACKUP_CONF}.env" || die "Could not read envfile."
elif [ -r "/etc/backup/${BACKUP_CONF}.env" ]; then
	. "/etc/backup/${BACKUP_CONF}.env" || die "Could not read envfile."
else
	die "Configuration '${BACKUP_CONF}' does not exist."
fi

case "$1" in
	run|"")
		borg create \
			-x \
			${OPT_BORG} ${OPT_BORG_CREATE} \
			::'{hostname}'${SUFFIX}'-{now:%Y-%m-%d_%H:%M}' \
			${EXCLUDE_FILE:+--exclude-from=${EXCLUDE_FILE}} \
			${EXCLUDE:+$(expand_excludes ${EXCLUDE[@]})} \
			${SOURCES[@]:-/} \
		|| die "borg failed to create archive."
		
		borg prune \
			${OPT_BORG} ${OPT_BORG_PRUNE} \
			--prefix='{hostname}'${SUFFIX} \
			${KEEP_WITHIN:+--keep-within=${KEEP_WITHIN}} \
			${KEEP_DAILY:+--keep-daily=${KEEP_DAILY}} \
			${KEEP_WEEKLY:+--keep-weekly=${KEEP_WEEKLY}} \
			${KEEP_MONTHLY:+--keep-monthly=${KEEP_MONTHLY}} \
			${KEEP_YEARLY:+--keep-yearly=${KEEP_YEARLY}} \
		|| die "borg failed to prune archives"
		;;
	*)
		borg ${OPT_BORG} $*
		;;
esac
